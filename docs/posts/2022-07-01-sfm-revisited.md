---
title: 「论文笔记」Structure-from-Motion Revisited
subtitle: Schonberger, et al. Structure-From-Motion Revisited. CVPR 2016
author: Krahets
date: 2022-07-01
tags: 
  - PaperReading

layout: Post
useHeaderImage: false
headerImage: 2022-07-01-sfm-revisited.assets/upgit_20220807_1659802324.png
catalog: true
giscus: true
---

::: link [Structure-from-Motion Revisited](https://openaccess.thecvf.com/content_cvpr_2016/papers/Schonberger_Structure-From-Motion_Revisited_CVPR_2016_paper.pdf)
:::

::: link [COLMAP](https://colmap.github.io/)
:::

## 1. 简介

<img src="/2022-07-01-sfm-revisited.assets/upgit_20220807_1659802324.png" alt="image-20220807001204568" style="zoom:50%;" />

增量式、多层式、全局式是当前三种主流 SfM 方案；目前，增量式 SfM 是处理非结构化照片集的最流行的方法。增量式 SfM 的主要问题是鲁棒性、精度、完整性、扩展性。

## 2. SfM 回顾

本文增量式 SfM pipeline ：特征提取、匹配、几何校验，输出场景图（scene graph）；选择初始两视图并重建；增量式注册新图片、三角化场景点、异常值过滤、BA 重优化。

<img src="/2022-07-01-sfm-revisited.assets/upgit_20220807_1659802352.png" alt="image-20220807001232902" style="zoom:50%;" />

### 2.1. 对应点搜索

第一步寻找图片中的相同场景，提取与匹配各图片中同一场景位置的 2D 像素点。

#### 特征提取

- 对于每张图片 $I_i$ ，SfM 检测局部特征集合 $F_i = {(x_j, f_j) | j = 1...N_{Fi}}$ 。
- 特征应该具有光度和几何不变性，从而可以在多张图片中唯一地被识别。
- SIFT 系列算法具有很好的鲁棒性。Binary Features 效率更好，但牺牲了一定鲁棒性。

#### 特征匹配

- SfM 通过在图像中搜索匹配特征，来发现场景中的相同部分。最直接的方案是暴力搜索所有图片对的所有特征对；其需要通过计算外观描述子 $f_j$ 之间的相似度，来查找图片 $I_a$ 中每个特征在图片 $I_b$ 中的最相似特征，时间复杂度为 $N_I^2 N_{F_i}^2$，无法应用于大规模图片集。现有多种方法提升特征匹配效率。
- 本阶段输出是潜在重叠图片对的集合 $C = \{ I_a, I_b | I_a, I_b \in I, a < b \}$ 和它们的对应特征集合 $M_{ab} \in F_a \times F_b$ 。

#### 几何校验

- 由于匹配步骤仅基于图片外观，无法保证匹配特征映射到同一场景点的正确性。因此 SfM 使用投影几何来映射两张图片中的特征点。
- 根据图像对的空间配置，使用不同的映射来描述它们之间的几何关系。单应性变换 $H$ 描述相机拍摄平面场景的旋转或平移变换。极线几何描述相机沿着本质矩阵 $E$（已校准）或基础矩阵 $F$（未校准）的运动关系。
- 如果变换在图片间映射了充足数量特征，则被认为通过几何校验。本阶段输出也被称为场景图（scene graph），图片作为节点，校验通过图片配对关系作为边。

### 2.2 增量式重建

重建阶段的输入是场景图，输出是配准图像的姿态估计 $P = \{P_c \in SE(3) | c = 1 \dots N_P\}$ 和重建场景点云 $X = \{X_k∈ R^3| k = 1...N_X\}$ 。

#### 初始化

- SfM 小心地选择一个两视图重建结果来初始化模型。此步骤非常关键，因为模型基本无法从错误的初始化中恢复。
- 从场景图的密集位置初始化通常可以得到更加鲁棒和精确的重建结果。相反地，从稀疏位置初始化可以减少运行时间，因为 BAs 处理总体更加稀疏的问题。

#### 图像配准

使用当前模型的 3D 点和新图片的对应 2D 特征，通过解 PnP 问题，可将新图片配准进当前模型。PnP 问题包括估计姿态 $P_c$ ，对于未校准相机，还有其内参。

#### 三角化

- 新配准的图像在观测到现有 3D 点的同时，也能通过三角化来增加新点集，从而拓展场景覆盖。
- 三角化是 SfM 的关键步骤，因为其通过冗余性来提升模型稳定性，并通过添加新的 2D-3D 对应关系来拓展可配准的新图片范围。

#### 捆集调整（Bundle Adjustment, BA）

- 图像配准和三角化是分离的两个步骤，即使它们的产出是高度相关的——相机位姿和三角化点的不确定性会相互传递。若无进一步的优化，SfM 模型通常会快速漂移到无法恢复。
- BA 是针对相机参数和点集参数的联合非线性优化，其目标函数为最小化重投影误差。Schur 首先求解简化的相机系统，然后通过反向替换更新 3D 点。该方案通常更有效，因为摄像机的数量通常小于点的数量。
- 求解系统的两种选择：精确和非精确步长算法。
    - 精确方法通过将其存储和分解为密集或稀疏矩阵来求解系统，空间复杂度为 $O(N_P^2)$ ，时间复杂度为 $O(N_P^3)$ 。
    - 非精确方法近似求解系统，通常使用迭代求解器，例如预处理共轭梯度（PCG），其时间和空间复杂度为 $O(N_P)$ 。
    - 直接算法是多达数百台摄像机的首选方法，但在大规模问题中成本太高。虽然稀疏直接方法在很大程度上降低了稀疏问题的复杂性，但由于连接图通常密度更大，因此它们不适用于大型非结构化照片采集，此类情况中首选非直接算法。

## 3.  挑战

当前 SOTA 方法的建模完整性和鲁棒性不足，例如：一些看起来应该被配准的图片经常配准失败；系统由于错误配准或漂移，输出错误模型。主要有以下原因：

- 可能是由于特征提取和匹配输出不完整的场景图，从而既不提供完整模型所需的连接，也不为可靠的估计提供足够冗余。
- 可能是由于缺少或不准确的场景结构导致重建阶段无法配准图像造成的 —— 图像配准和三角化拥有共生关系，即图像仅能给予现有场景结构配准，而场景结构仅能通过图像对的三角化得到。

最大限度地提高两者的准确性和完整性，是 SfM 的关键挑战。

## 4. 贡献

1. 几何校验策略，用于增强场景图，从而改善初始化和三角化组件的鲁棒性。
2. 下一最优视角选择方法，最大化增量式重建流程的鲁棒性和精度。
3. 鲁棒三角化方法，产出比 SOTA 方法更加完整的场景结构，并降低计算成本。
4. 迭代式 BA 、重三角化、异常值过滤策略，通过缓解漂移效应来显著改善完整性和精度。
5. 冗余视图挖掘，为密集照片集提供了更高效的 BA 参数化。

### 4.1. 场景图增强

作者提出一种多模型几何校验策略，用几何关系来增强场景图。估计视角对的基础矩阵 $F$ 、关键矩阵 $E$ （已校准相机）、单应矩阵 $H$ ，设内点数分别为 $N_F$ , $N_E$ , $N_H$ ，则判断规则如下：

1. 若找到 $>N_F$ 个内点，则此视角对通过校验。
2. 如果 $N_E / N_F > \epsilon_{EF}$ ，则认为相机被正确校准。对于正确校准且 $N_H / N_F < \epsilon_{HF}$ 情况，作者将 $E$ 分解，根据内点对应关系来三角化，计算三角化角度中位数 $\alpha_m$ ，用之区分纯旋转（全景式）和平面场景（平面式）情况。
3. 网络图片经常有水印、时间戳、帧（WTFs），错误地连接了不同地区的图像。作者通过在图像边界处估计相似变换得到 $N_S$ 个内点，并将满足 $N_S / N_F > \epsilon_{SF} \vee N_S / N_E > \epsilon_{SE}$ 的图像从场景图中滤出。

后续重建仅针对非全景图像和高质量校准图像进行。增强场景图能够找到最优初始化，以达到鲁棒场景重建。此外，作者不对全景式图像对进行三角化，来避免劣化 3D 点，从而提高三角化和图像配准的鲁棒性。

### 4.2. 下一最优视角选择 (Next Best View)

下一最优视角选择可以最小化重建误差。网络图片集往往没有关于场景覆盖和相机参数的先验信息，决策仅仅完全基于图片外观、两视图对应性、当前增量式重建场景。

常用策略是选择看到最多三角化点的图像，这样可以尽量减小相机后方交会的不确定性。Haner 等人提出一种不确定性驱动方法，其尽可能最小化重建误差。Lepetit 等人的实验展示了用 PnP 求解相机位姿精度取决于观测点的数量和在图片中的分布。对于网络图片集，标准 PnP 问题被拓展到未校准相机的内参估计。Haner 等人提出的穷举协方差传播是不可行的，因为需要在每个步骤计算和分析每个候选图片的协方差。作者提出一种高效的多分辨率网格分析方法：

1. 将二维图片上离散为 $K_l$ 个固定大小的网格单元，网格有两种状态：空、满。当重建点位于某网格内，则此网格转换为“满”，并将图片分数 $S_i$ 提升权重 $w_l$ 。由于单元格只计入总分数一次，因此此算法更倾向于选定均匀分布。
2. 然而，如果可视点 $N_t \ll L_l^2$ ，则可能每个点都落入不同网格，导致不能很好地评价点集分布。因此，作者通过构建 $l=1 \dots L$ 的多分辨率金字塔（网格数 $K_l = 2^L$ ），总分数为在各分辨率上的加权和 $w_l = K^2$。

<img src="/2022-07-01-sfm-revisited.assets/upgit_20220807_1659802403.png" alt="image-20220807001323433" style="zoom:50%;" />

### 4.3. 高效鲁棒三角化 (Triangulation)

匹配技术通常偏向外观一致的图片对，因此匹配两视图通常基线较小；利用传递性，可在基线较大的两图像之间建立对应关系，从而提升三角化精度。作者提出了一种有效的、基于采样的三角化方法。

特征轨迹 (track) 通常包含大量异常值，单个不匹配会链式合并两个或多个独立点的轨迹。另外，低精度相机位姿的反投影误差过大，可能导致轨迹元素失效。Bundler 对轨迹元素的所有成对组合进行采样，执行双视图三角化，并检查是否至少有夹角足够大的视图对。如果找到一个合格解，则会在整个轨迹上执行多视图三角化，并筛选所有通过 cheirality 约束的 3D 点。此方法对于异常值的鲁棒性差，并且穷举三角化的效率较低。作者的方法克服了以上局限性。

作者提出一种基于 RANSAC 的三角化方法，克服了以上局限性。考虑特征轨迹 $T = \{ T_n | n = 1 \dots N_T \}$ ，其内点比例 $\epsilon$ 未知。一个测量 $T_n$ 包含归一化的图片观测 $\bar{x}_n$ 和对应的相机姿态 $P_n$ 。目标是使符合一个双目三角化的测量达到最大化

$$
X_{ab} \sim \tau(\bar{x}_a, \bar{x}_b, P_a, P_b) \space \rm{with} \space a \ne b
$$

其中 $\tau$ 是任意三角化方法（作者使用 DLT 方法）， $X_{ab}$ 是三角化 3D点 。高质量模型满足两个约束

- 三角化夹角 $\alpha$ 足够大

$$
\cos \alpha = \frac{t_a - X_{ab}}{|| t_a - X_{ab} ||_2} \frac{t_b X_{ab}}{|| t_b - X_{ab} ||_2}
$$

- 深度 $d_a$ , $d_b$ 为正（cherality 约束），且重投影误差 $e_n$ 小于阈值 $t$

$$
d = [p_{31} \space p_{32} \space p_{33} \space p_{34}] [X_{ab}^T \space 1]^T
$$

$$
e_n = || \bar{x}_n - \begin{bmatrix} x' / z'  \\ y' / z' \end{bmatrix} ||_2 \\ \rm{with} \begin{bmatrix} x'  \\ y' \\ z' \end{bmatrix} = P_n \begin{bmatrix} X_{ab}  \\ 1 \end{bmatrix}
$$

RANSAC 迭代方法使 $K$ 最大化，随机均匀地对大小为 2 的最小集合进行采样。

### 4.4. 捆集调整（BA）

BA 用于消除累积误差。作者在图像配准后，在一组最相关图片上做 local BA ，与VisualSFM类似，作者仅在模型增长固定百分比后再执行全局BA，从而保证 SfM 的分摊运行时间是线性级别。

- **参数化：** Local BA 中使用 Cauchy 函数作为鲁棒损失函数；对于上百个相机规模问题，使用直接稀疏求解器；对于更大规模问题，使用 PCG 求解器。
- **过滤：** 在 BA 之后，会出现许多重投影误差较大观测，过滤之；并且对于每个点，检查所有相机对的三角化角度是否大于阈值。在全局 BA 之后，检查退化相机，通常此类相机的所有观测均为异常值，或者内参收敛劣化。
- **重三角化：** BA 往往会显著提升相机参数和 3D 点精度，提升三角化点的数量，因此再做一次三角化来提升重建完整性。
- **迭代优化：** 一次 BA 之后许多异常点会被过滤。由于异常点会严重影响 BA 结果，因此第二轮 BA 可以进一步显著提升精度。作者提出迭代式 BA 、过滤、重三角化，直到被过滤的观测和重三角化点减少时停止。

### 4.5. 冗余视角挖掘

BA 是 SfM 主要的性能瓶颈。对于大规模问题，场景大部分不受 BA 影响，因为模型一般都是局部更新的。 BA 通常主要对新添加的部分进行优化，其他部分仅优化漂移。

作者将场景划分为多个由高重叠率的多个相机构成的分组 $G = \{ G_r | r = 1 \dots N_G \}$ ，并且每个分组 $G_R$ 被参数化为一个单独相机。将被最新拓展影响到的图片单独分一组，以得到最优结果。BA 代价函数被重写为

$$
E_g = \sum_j \rho_j (|| \pi_g (G_r, P_c, X_k) - x_j ||_2^2)
$$

其中 $P_c$ 固定不变，分组内图片投影矩阵是分组姿态 $G_r$ 和组内图片姿态 $P_c$ 的连乘 $P_{cr} = P_c G_r$ 。总体代价 $\bar{E}$ 是分组代价和非分组代价之和。
